{% extends "core/layouts/blank.html" %}
{% load static %}

{% block title %}Парсер Stparts - Обработка файла{% endblock %}

{% block content %}
<style>
.timeline-compact {
  align-items: flex-start !important;
  justify-content: flex-start !important;
}
.timeline-icon-substep {
    transition: color 0.3s ease-in-out;
}
</style>

<div class="container mx-auto p-4 md:p-6">
    <div class="text-sm breadcrumbs mb-6">
        <ul>
            <li><a href="{% url 'index' %}" class="text-primary">Главная</a></li>
            <li><a href="{% url 'parser:upload' %}">Парсер Stparts</a></li>
            <li class="text-gray-500">Обработка файла</li>
        </ul>
    </div>

    <div class="card-body items-center text-center p-0">
        <h2 class="card-title text-2xl font-bold mb-4">Обработка файла</h2>
        <p class="mb-6 text-base-content/60">Пожалуйста, подождите, пока мы парсим данные. Это может занять несколько минут.</p>

        <ul class="timeline timeline-vertical timeline-compact">
            <li id="timeline-step-reading-file">
                <div class="timeline-middle">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 timeline-icon"></svg>
                </div>
                <div class="timeline-end timeline-box text-start">
                    <div class="font-bold">Читаем файл</div>
                    <div class="text-xs opacity-70">Проверяем .xlsx файл и список артикулов</div>
                    <div class="text-xs text-error-content opacity-70 error-details mt-1"></div>
                </div>
                <hr/>
            </li>
            <li id="timeline-step-parsing">
                <hr/>
                <div class="timeline-middle">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 timeline-icon"></svg>
                </div>
                <div class="timeline-end timeline-box text-start">
                    <div class="font-bold">Парсим stparts</div>
                    <div id="parsing-progress" class="mt-2 flex items-center gap-2">
                        <progress class="progress progress-primary w-56" value="0" max="100"></progress>
                        <span id="parsing-percentage" class="font-mono text-sm">0%</span>
                    </div>
                    <div class="text-xs text-error-content opacity-70 error-details mt-1"></div>
                </div>
                <hr/>
            </li>
            <li id="timeline-step-excel-export">
                <hr/>
                <div class="timeline-middle">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 timeline-icon"></svg>
                </div>
                <div class="timeline-end timeline-box text-start">
                    <div class="font-bold">Записываем результат в Excel</div>
                     <div id="excel-progress" class="mt-2 flex items-center gap-2">
                        <progress class="progress progress-primary w-56" value="0" max="100"></progress>
                        <span id="excel-percentage" class="font-mono text-sm">0%</span>
                    </div>
                    <div class="text-xs text-error-content opacity-70 error-details mt-1"></div>
                </div>
                <hr/>
            </li>
             <li id="timeline-step-complete">
                <hr/>
                <div class="timeline-middle">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 timeline-icon"></svg>
                </div>
                <div class="timeline-end timeline-box text-start">
                    <div class="font-bold">Завершено</div>
                </div>
            </li>
        </ul>

        <div id="upload-result" class="mt-6 w-full max-w-md"></div>

    </div>
</div>

<script>
    const ICONS = {
        pending: `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM5 10a5 5 0 1110 0 5 5 0 01-10 0z" clip-rule="evenodd" />`,
        in_progress: `<path d="M10 2a8 8 0 1 0 5.657 13.657A8 8 0 0 0 10 2zm0 14a6 6 0 1 1 0-12 6 6 0 0 1 0 12z" fill-opacity="0.4"/><path d="M10 2a8 8 0 0 1 8 8h-2a6 6 0 0 0-6-6V2z"><animateTransform attributeName="transform" type="rotate" from="0 10 10" to="360 10 10" dur="1s" repeatCount="indefinite"/></path>`,
        success: `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />`,
        failure: `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />`
    };

    const STEP_MAP = {
        'читаем файл': 'timeline-step-reading-file',
        'парсим stparts': 'timeline-step-parsing',
        'записываем результат в excel': 'timeline-step-excel-export'
    };

    function updateTimelineItem(timelineItem, status, detailsText = null) {
        if (!timelineItem) return;
        const timelineBox = timelineItem.querySelector('.timeline-box');
        const icon = timelineItem.querySelector('.timeline-icon');
        const detailsDiv = timelineItem.querySelector('.error-details');
        const hrs = timelineItem.querySelectorAll('hr');
        const outgoingHr = hrs.length ? hrs[hrs.length - 1] : null;
        const nextLi = timelineItem.nextElementSibling;
        const nextIncomingHr = nextLi ? nextLi.querySelector('hr') : null;

        icon.innerHTML = ICONS[status.toLowerCase()] || ICONS.pending;

        if (status === 'SUCCESS' || status === 'FAILURE') {
            if (status === 'SUCCESS') {
                timelineBox && timelineBox.classList.add('border', 'border-success');
                icon && icon.classList.add('text-success');
                outgoingHr && outgoingHr.classList.add('bg-success');
                nextIncomingHr && nextIncomingHr.classList.add('bg-success');
            } else {
                timelineBox && timelineBox.classList.add('border', 'border-error');
                icon && icon.classList.add('text-error');
                outgoingHr && outgoingHr.classList.add('bg-error');
                nextIncomingHr && nextIncomingHr.classList.add('bg-error');
            }
        }
        if (detailsText && detailsDiv) detailsDiv.textContent = detailsText;
    }

    function handleProgressUpdate(meta) {
        const stepId = STEP_MAP[(meta.step || '').toLowerCase()];
        if (!stepId) return;

        const stepElement = document.getElementById(stepId);
        if (!stepElement) return;

        if (meta.hasOwnProperty('progress')) {
            const progressBar = stepElement.querySelector('progress');
            const percentageSpan = stepElement.querySelector('span[id$="-percentage"]');
            if (progressBar) progressBar.value = meta.progress;
            if (percentageSpan) percentageSpan.textContent = `${meta.progress}%`;
        }

        if (meta.hasOwnProperty('status')) {
            let details = meta.details ? meta.details.error : null;
            updateTimelineItem(stepElement, meta.status, details);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const url = "{% url 'parser:task_status' task_id=task_id %}";
        const es = new EventSource(url, { withCredentials: true });

        const resultDiv = document.getElementById('upload-result');
        const backLink = `<div class="mt-4"><a href="{% url 'parser:upload' %}" class="btn btn-link">Назад к загрузке файла</a></div>`;
        const completeStep = document.getElementById('timeline-step-complete');

        // Set initial states
        Object.values(STEP_MAP).forEach(id => updateTimelineItem(document.getElementById(id), 'PENDING'));
        updateTimelineItem(completeStep, 'PENDING');

        es.onmessage = (event) => {
            try {
                const payload = JSON.parse(event.data);
                console.log("SSE Message:", payload);

                if (payload.status === 'PROGRESS' && payload.meta) {
                    handleProgressUpdate(payload.meta);
                }

                if (payload.status === 'SUCCESS' || (payload.status === 'COMPLETE' && payload.result)) {
                    es.close();
                    const result = payload.result;

                    // Mark all steps as success
                    Object.values(STEP_MAP).forEach(id => updateTimelineItem(document.getElementById(id), 'SUCCESS'));
                    updateTimelineItem(completeStep, 'SUCCESS');

                    let failedCount = result.failed_count || 0;
                    let message = `Парсинг завершен. Не удалось спарсить ${failedCount} артикулов.`;
                    let downloadLink = `<a href="${result.export_url}" class="btn btn-primary mt-4">Скачать отчет</a>`;

                    resultDiv.innerHTML = `<div class="alert alert-success"><span>${message}</span></div><div class="mt-4">${downloadLink}</div>` + backLink;
                }

                if (payload.status === 'FAILURE') {
                    es.close();
                    const errorDetails = payload.result ? (payload.result.exc_message || 'Неизвестная ошибка') : "Неизвестная ошибка";
                    const failedStep = payload.meta ? payload.meta.step : "Unknown Step";
                    const failedStepId = STEP_MAP[(failedStep || '').toLowerCase()];

                    if (failedStepId) {
                        updateTimelineItem(document.getElementById(failedStepId), 'FAILURE', errorDetails);
                    }

                    updateTimelineItem(completeStep, 'FAILURE');
                    resultDiv.innerHTML = `<div class="alert alert-error"><span>Ошибка на шаге '${failedStep}': ${errorDetails}</span></div>` + backLink;
                }
            } catch (err) {
                 console.error("Failed to parse SSE data:", err, event.data);
                 resultDiv.innerHTML = `<div class="alert alert-error"><span>Произошла ошибка при отслеживании прогресса.</span></div>` + backLink;
                 es.close();
            }
        };

        es.onerror = (error) => {
            console.warn("SSE error:", error);
            es.close();
            resultDiv.innerHTML = `<div class="alert alert-error"><span>Ошибка соединения при отслеживании прогресса.</span></div>` + backLink;
        };
    });
</script>

{% endblock %}
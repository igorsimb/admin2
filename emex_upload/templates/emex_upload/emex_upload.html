{% extends "core/layouts/blank.html" %}
{% block title %}Загрузка данных Emex{% endblock %}

{% block content %}
<div class="container mx-auto p-4 md:p-6">

    <div class="text-sm breadcrumbs mb-6">
        <ul>
            <li><a href="{% url 'index' %}" class="text-primary">Главная</a></li>
            <li class="text-gray-500">Загрузка данных Emex</li>
        </ul>
    </div>

    {% if messages %}
    <div class="space-y-2 mb-6">
        {% for message in messages %}
        <div role="alert" class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'warning' %}alert-warning{% elif message.tags == 'error' %}alert-error{% else %}alert-info{% endif %} shadow-md">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                {% if message.tags == 'success' %}
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                {% elif message.tags == 'error' or message.tags == 'warning' %}
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                {% else %}
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                {% endif %}
            </svg>
            <span>{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="card-body items-center text-center p-0">
        <h2 class="card-title text-2xl font-bold mb-4">Загрузка данных Emex</h2>
        <p class="mb-6 text-base-content/60">Выберите txt-файл для загрузки и обработки (макс. размер 1GB).</p>

        <form action="{% url 'emex_upload:upload' %}" method="post" enctype="multipart/form-data" class="w-full max-w-md" id="upload-form">
            {% csrf_token %}
            <div class="form-control w-full">
                {{ form.file }}
            </div>

            <div class="card-actions justify-center mt-6">
                <button id="upload-btn" type="submit" class="btn btn-primary w-full">Загрузить файл</button>
            </div>

            <div id="upload-progress-wrap" class="mt-4 hidden text-left">
                <progress id="upload-progress" class="progress progress-primary w-full" value="0" max="100"></progress>
                <div id="upload-progress-text" class="mt-2 text-sm text-base-content/70">Загружено 0 из 0 MB</div>
            </div>

            <div id="upload-error" class="mt-3 hidden text-sm text-error"></div>
        </form>
    </div>
</div>

<script>
document.getElementById("upload-form").addEventListener("submit", function(event) {
    event.preventDefault();

    const form = event.currentTarget;
    const fileInput = form.querySelector('input[type="file"]');
    const file = fileInput && fileInput.files ? fileInput.files[0] : null;

    if (!file) {
        return;
    }

    const btn = document.getElementById("upload-btn");
    const progressWrap = document.getElementById("upload-progress-wrap");
    const progressBar = document.getElementById("upload-progress");
    const progressText = document.getElementById("upload-progress-text");
    const errorBox = document.getElementById("upload-error");

    const toMb = function(bytes) {
        return (bytes / (1024 * 1024)).toFixed(1);
    };

    btn.disabled = true;
    btn.textContent = "Загрузка...";
    errorBox.classList.add("hidden");
    progressWrap.classList.remove("hidden");

    const totalMb = toMb(file.size);
    progressBar.value = 0;
    progressText.textContent = `Загружено 0.0 из ${totalMb} MB`;

    const xhr = new XMLHttpRequest();
    xhr.open("POST", form.action, true);

    xhr.upload.addEventListener("progress", function(e) {
        if (!e.lengthComputable) {
            return;
        }

        const percent = (e.loaded / e.total) * 100;
        progressBar.value = percent;
        progressText.textContent = `Загружено ${toMb(e.loaded)} из ${toMb(e.total)} MB`;
    });

    xhr.addEventListener("load", function() {
        if (xhr.status >= 200 && xhr.status < 300) {
            document.open();
            document.write(xhr.responseText);
            document.close();
            return;
        }

        btn.disabled = false;
        btn.textContent = "Загрузить файл";
        errorBox.textContent = "Ошибка загрузки. Попробуйте еще раз.";
        errorBox.classList.remove("hidden");
    });

    xhr.addEventListener("error", function() {
        btn.disabled = false;
        btn.textContent = "Загрузить файл";
        errorBox.textContent = "Сетевая ошибка при загрузке файла.";
        errorBox.classList.remove("hidden");
    });

    xhr.send(new FormData(form));
});
</script>
{% endblock %}
